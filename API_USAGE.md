## Embroidery Render API

This lightweight HTTP service accepts an embroidery file (`.pes` or compatible formats supported by your importer), renders a single still image on a white background using Blender, and streams the resulting PNG back to the caller. It is intended for use inside your trusted network so you can prototype client tooling without sharing files externally.

### Prerequisites

- Blender accessible at `/opt/blender/blender` with the bundled scene (`BlenderSetup.blend`) and scripts in this repository.
- Python 3.10+ with the following packages:
  ```bash
  pip install fastapi uvicorn python-multipart
  ```
- The Blender Python dependencies already set up for your existing pipeline (ImporterScript, etc.).

### First-Time Environment Setup (recommended workflow)

1. **Create/activate virtual environment**
   ```bash
   cd /home/topher/embroidery_visualizer
   python3 -m venv .venv
   source .venv/bin/activate
   ```
2. **Install Python dependencies**
   ```bash
   pip install -r requirements.txt
   pip install fastapi uvicorn python-multipart
   ```
   The `python-multipart` package is required for FastAPI to parse uploaded files.
3. **Verify Blender path** — Ensure `/opt/blender/blender` exists and launches Blender 4.3 in background mode.

### Start the Service

### Create a Virtual Environment (optional but recommended)

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install fastapi uvicorn
```

### Start the Service

From the repository root run:
```bash
uvicorn render_service:app --host 0.0.0.0 --port 8000
```

- `--host 0.0.0.0` exposes the API to other machines on the local network.
- Adjust the port if needed (default `8000`).
- This simple service launches a fresh headless Blender process for each request (the most reliable configuration we validated earlier).
- Keep this terminal open while the service runs. To stop, press `Ctrl+C`; wait for “Application shutdown complete” before restarting.
- If you see “Blender daemon exited unexpectedly,” inspect `processed_files/blender_daemon.log` and restart once the issue is resolved.
- If the server crashes and leaves behind `blender_worker.sock`, delete it (`rm blender_worker.sock`) before restarting.

You should see Uvicorn logs confirming the server is listening:
```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### Explore the API

- `GET /` returns a short JSON payload with the important URLs.
- `GET /health` reports basic status for monitoring or load balancers.
- `GET /docs` opens the autogenerated Swagger UI where you can upload a PES file manually and inspect responses.

### API Endpoints

| Method | Path       | Description                          |
|--------|------------|--------------------------------------|
| GET    | `/health`  | Returns `{"status": "ok"}` for probes |
| POST   | `/render`  | Accepts a PES upload and streams PNG |

#### POST `/render`

- **Request**: `multipart/form-data` containing one file field named `file`. The filename helps determine the output name.
- **Response**: `image/png` with the rendered still image. Headers include:
  - `Content-Disposition`: Suggested file name derived from the upload.
  - `X-Render-Time`: Total seconds spent inside Blender for the render.
  - `X-Input-Backup`: Relative path to the saved copy of the uploaded embroidery file inside `processed_files/`.
  - `X-Output-Backup`: Relative path to the rendered PNG stored in `processed_files/`.

Example `curl` request (run from a second terminal while the server is running):
```bash
curl -X POST http://SERVER_IP:8000/render \
     -F "file=@input_PES/snowflake.PES" \
     --output snowflake.png
```
- Keep Uvicorn running in its own terminal. Run `curl` from another terminal so the server stays live.

The output PNG is written to `snowflake.png`, and the terminal shows the rendered image size when the transfer completes. Run the command from the repository root (so the relative path resolves) or provide an absolute file path. Inspect the response headers for:

- `X-Render-Time`: Total seconds Blender spent on the job.
- `X-Step-Metrics`: JSON object containing the breakdown (`scene_reload`, `import`, `prep`, `configure`, `render`, `total`, `elapsed`).
- `X-Input-Backup` / `X-Output-Backup`: Saved paths for audit.

Every upload is backed up automatically and metrics are recorded:

Every upload is backed up automatically:

- Uploaded PES is saved under `processed_files/` with the original base name, a UNIX timestamp, and numeric suffix if necessary (e.g., `snowflake_1713398620.pes`, `snowflake_1713398620_1.pes`).
- The rendered PNG is written alongside it using the same timestamp (e.g., `snowflake_1713398620.png`).
- Inspect the directory at any time: `ls processed_files`.
- The service logs Blender command output to `processed_files/render_service.log`.

Python example using `requests` (run from any trusted machine with network access):
```python
import requests

with open("snowflake.PES", "rb") as pes:
    response = requests.post("http://SERVER_IP:8000/render", files={"file": pes})
response.raise_for_status()

with open("snowflake.png", "wb") as out_file:
    out_file.write(response.content)

print("Render time:", response.headers.get("X-Render-Time", "n/a"), "seconds")
print("Step metrics:", response.headers.get("X-Step-Metrics", "{}"))
```

### Error Handling

- HTTP `400`: Missing file field or filename.
- HTTP `500`: Blender or importer failure (the error message will include Blender’s stderr).
- Common 500 causes:
  - **Color ramp limit** – some embroidery files specify more than 32 thread colors. The server now caps the color ramp automatically; if you still see related errors, restart the API to rebuild the Blender worker.
  - **Stale socket** – leftover `blender_worker.sock` from a crash. Delete the socket and restart the service.

Logs are emitted in the server console; review them when diagnosing render issues.

### Stopping the Service

Press `Ctrl+C` in the terminal running Uvicorn. Blender processes are only spawned per request and exit once the still image has been rendered.
